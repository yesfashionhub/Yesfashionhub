<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>YesFashionHub - Cart & Order</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      body{font-family:Inter,system-ui,Arial;margin:0;background:#f5f5f7}
      .container{max-width:900px;margin:20px auto;padding:16px;background:#fff;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.06)}
      h2{margin-top:0}
      .item{display:flex;gap:12px;padding:10px 0;border-bottom:1px solid #eee;align-items:center}
      .item img{width:80px;height:80px;object-fit:cover;border-radius:6px}
      .right{margin-left:auto;text-align:right}
      .btn{padding:8px 12px;border-radius:6px;border:none;background:#0b74ff;color:#fff;cursor:pointer}
      .loader{display:none;position:fixed;inset:0;background:rgba(255,255,255,0.8);align-items:center;justify-content:center;z-index:999}
      .spinner{border:5px solid #eee;border-top:5px solid #0b74ff;border-radius:50%;width:44px;height:44px;animation:spin 1s linear infinite;margin-right:12px}
      @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
      .controls{display:flex;gap:8px;flex-wrap:wrap}
      input, textarea{width:100%;padding:8px;border:1px solid #ddd;border-radius:6px}
    </style>
  </head>
  <body>
    <div class="container">
      <h2>Yes Fashion Hub — Your Cart</h2>
      <div id="items"></div>
      <div style="text-align:right;font-weight:700;margin-top:12px" id="total"></div>

      <h3 style="margin-top:18px">Customer details</h3>
      <div style="margin-bottom:8px"><input id="custName" placeholder="Your name" /></div>
      <div style="margin-bottom:12px"><textarea id="custAddress" rows="3" placeholder="Delivery address"></textarea></div>

      <div class="controls">
        <button id="confirmBtn" class="btn">Confirm Order — Generate PDF & Upload</button>
        <button id="clearBtn" class="btn" style="background:#888">Clear Cart</button>
      </div>
    </div>

    <div id="loader" class="loader" style="display:none;align-items:center;justify-content:center">
      <div class="spinner"></div>
      <div style="font-weight:700;color:#0b74ff">Processing order — please wait...</div>
    </div>

    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
    (async function(){
      // ====== CONFIG - change only APPS_SCRIPT_UPLOAD_URL to your deployed Web App URL ======
      const APPS_SCRIPT_UPLOAD_URL = 'PASTE_YOUR_APPS_SCRIPT_WEBAPP_URL_HERE'; // <-- replace with Apps Script Web App URL from deploy
      const WHATSAPP_NUMBER = '919978653852'; // your number with country code, no plus sign
      // ====================================================================================

      // Sample cart source: use your actual product list source (here we read from localStorage 'yf_cart')
      const cart = (() => {
        try { return JSON.parse(localStorage.getItem('yf_cart') || '[]') } catch(e){ return [] }
      })();

      // render cart
      const itemsDiv = document.getElementById('items');
      const totalDiv = document.getElementById('total');
      function renderCart() {
        itemsDiv.innerHTML = '';
        let total=0;
        if (!cart || cart.length === 0) {
          itemsDiv.innerHTML = '<div style="padding:10px;color:#666">Your cart is empty</div>';
          totalDiv.innerText = '';
          return;
        }
        cart.forEach((it, idx) => {
          total += Number(it.prate || it.prate==='' ? (Number(it.prate)||Number(it.price)||0) : 0) || Number(it.price||it.prate||0);
          const row = document.createElement('div');
          row.className = 'item';
          row.innerHTML = `
            <img src="${escapeHtml(formatImage(it.pimage||it.image||it.Pimage||''))}" />
            <div>
              <div style="font-weight:700">${escapeHtml(it.pname||it.name||'Unnamed')}</div>
              <div style="color:#555">${escapeHtml(it.pdesc||it.desc||'')}</div>
              <div style="color:#777;font-size:13px">Size: ${escapeHtml(it.psize||it.size||'-')}</div>
            </div>
            <div class="right">₹ ${Number(it.prate||it.price||0).toFixed(2)}</div>
          `;
          itemsDiv.appendChild(row);
        });
        totalDiv.innerText = 'Total: ₹' + Number(total).toFixed(2);
      }
      function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));}

      function formatImage(url){
        if(!url) return '';
        // If it's drive "open?id=" convert to uc?export=view
        if (url.includes('drive.google.com/open?id=')) {
          const id = url.split('id=')[1].split('&')[0];
          return `https://drive.google.com/uc?export=view&id=${id}`;
        }
        if (url.includes('drive.google.com/file/d/')) {
          const id = url.split('/d/')[1].split('/')[0];
          return `https://drive.google.com/uc?export=view&id=${id}`;
        }
        // already fine or raw github / http
        return url;
      }

      renderCart();

      // helper: add image to PDF — fetch image as blob -> dataURL
      async function fetchImageDataURL(url) {
        if (!url) return null;
        try {
          const resp = await fetch(url, {mode:'cors'});
          if (!resp.ok) throw 'HTTP ' + resp.status;
          const blob = await resp.blob();
          return await new Promise((res, rej) => {
            const fr = new FileReader();
            fr.onload = ()=>res(fr.result);
            fr.onerror = rej;
            fr.readAsDataURL(blob);
          });
        } catch (err) {
          console.warn('Image fetch failed', url, err);
          return null;
        }
      }

      // Build PDF (thumbnails) and return blob
      async function buildPdfBlob(customerName, customerAddress) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({unit:'pt', format:'a4'});
        const startX = 40;
        let y = 40;
        doc.setFontSize(18);
        doc.text('Yes Fashion Hub - Order', startX, y);
        doc.setFontSize(12);
        y += 20;
        doc.text(`Customer: ${customerName}`, startX, y); y += 16;
        doc.text(`Address: ${customerAddress}`, startX, y); y += 20;

        let total = 0;
        for (const it of cart) {
          const price = Number(it.prate || it.price || 0);
          total += price * (it.qty || 1);

          // image thumbnail (try)
          const imgUrl = formatImage(it.pimage || it.image || '');
          const dataUrl = imgUrl ? await fetchImageDataURL(imgUrl) : null;
          if (dataUrl) {
            try { doc.addImage(dataUrl, 'JPEG', startX, y, 60, 60); } catch(e){ console.warn('addImage fail', e); }
          }

          // product text
          const leftTextX = startX + 70;
          doc.setFontSize(12);
          doc.text(String(it.pname || it.name || ''), leftTextX, y + 16);
          if (it.pdesc) doc.setFontSize(10), doc.text(String(it.pdesc), leftTextX, y + 32);
          doc.setFontSize(10);
          doc.text(`Size: ${it.psize || it.size || '-'} | ₹${price} x ${it.qty||1}`, leftTextX, y + 48);
          y += 80;
          if (y > 720) { doc.addPage(); y = 40; }
        }

        doc.setFontSize(13);
        doc.text(`Total: ₹${Number(total).toFixed(2)}`, startX, y + 20);

        // return blob
        const dataUri = doc.output('datauristring');
        const parts = dataUri.split(',');
        const mime = parts[0].match(/:(.*?);/)[1];
        const b64 = parts[1];
        const bytes = atob(b64);
        const u8 = new Uint8Array(bytes.length);
        for (let i=0;i<bytes.length;i++) u8[i] = bytes.charCodeAt(i);
        return new Blob([u8], { type: mime });
      }

      // upload blob base64 to Apps Script
      async function uploadPdfToAppsScript(filename, blob) {
        const reader = new FileReader();
        const promise = new Promise((res, rej) => {
          reader.onload = ()=>res(reader.result);
          reader.onerror = rej;
        });
        reader.readAsDataURL(blob);
        const dataUrl = await promise; // data:<mime>;base64,<b64>
        const base64 = dataUrl.split(',')[1];

        // POST
        const payload = { filename: filename, contentBase64: base64 };
        const resp = await fetch(APPS_SCRIPT_UPLOAD_URL, {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify(payload)
        });
        return await resp.json();
      }

      // UI handlers
      document.getElementById('confirmBtn').addEventListener('click', async function(){
        const name = document.getElementById('custName').value.trim();
        const address = document.getElementById('custAddress').value.trim();
        if (!name || !address) { alert('Please enter name and address'); return; }
        if (!cart || cart.length === 0) { alert('Cart empty'); return; }

        // show loader
        document.getElementById('loader').style.display = 'flex';

        try {
          const safeName = name.replace(/\s+/g,'_').replace(/[^a-zA-Z0-9_\-]/g,'');
          const datePart = (new Date()).toISOString().slice(0,10);
          const filename = `${safeName}_${datePart}.pdf`;

          const pdfBlob = await buildPdfBlob(name, address);

          // upload to Apps Script (which will save into your Drive Orders folder)
          const uploadResult = await uploadPdfToAppsScript(filename, pdfBlob);

          // hide loader
          document.getElementById('loader').style.display = 'none';

          if (uploadResult && uploadResult.success && uploadResult.url) {
            const pdfLink = uploadResult.url; // shareable Drive link (viewer)
            const message = `My Name is ${name}%0AAddress: ${address}%0A%0APlease find my Order PDF and confirm my order soon as possible.%0A${pdfLink}`;
            // open WhatsApp
            window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(message)}`, '_blank');
            alert('Order uploaded & WhatsApp opened (click the link to view the PDF).');
            // optional: keep cart or clear as you want
          } else {
            console.error('Upload failed', uploadResult);
            alert('Upload failed. See console for details.');
          }
        } catch (err) {
          document.getElementById('loader').style.display = 'none';
          console.error(err);
          alert('Error creating/uploading PDF. Check console.');
        }
      });

      document.getElementById('clearBtn').addEventListener('click', function(){
        localStorage.removeItem('yf_cart');
        location.reload();
      });

    })();
    </script>
  </body>
</html>
