<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>YesFashionHub - WhatsApp Store</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <meta http-equiv="Cache-Control" content="public, max-age=31536000">

    <style>
      * { box-sizing: border-box; }

      body {
        font-family: 'Inter', system-ui, Arial;
        margin: 0;
        background: #e5ddd5;
        overflow-x: hidden;
      }

      /* HEADER */
      header {
        background: #25D366;
        color: #fff;
        padding: 10px 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: sticky;
        top: 0;
        z-index: 1000;
        box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      }

      .logo-wrap img {
        height: 90px;
        width: auto;
        align-items: center;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(255,255,255,0.8),
                    0 2px 6px rgba(0,0,0,0.25);
        background: rgba(255,255,255,0.15);
        padding: 4px;
      }

      .cart-wrap {
        position: relative;
      }

      .cart-btn {
        background: #128C7E;
        border: none;
        border-radius: 50%;
        width: 44px;
        height: 44px;
        font-size: 22px;
        color: #fff;
        cursor: pointer;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        transition: transform 0.2s ease, background-color 0.3s;
      }

      .cart-btn:hover {
        transform: scale(1.1);
        background: #20ba5a;
      }

      .cart-count {
        position: absolute;
        top: -6px;
        right: -6px;
        background: #ff3b30;
        color: #fff;
        border-radius: 50%;
        font-size: 12px;
        padding: 3px 6px;
      }

      .controls {
        background: #fff;
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 12px;
      }

      .controls input,
      .controls select {
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 8px;
        font-size: 15px;
        width: 100%;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 12px;
        padding: 12px;
      }

      .card {
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        transition: transform 0.2s ease;
      }

      .card:hover { transform: scale(1.02); }

      .card img {
        width: 100%;
        height: 160px;
        object-fit: cover;
      }

      .card h3 {
        margin: 10px 8px 0;
        font-size: 16px;
        color: #222;
      }

      .card p {
        margin: 4px 8px;
        font-size: 14px;
        color: #555;
      }

      .btn {
        background: #25D366;
        color: #fff;
        border: none;
        border-radius: 6px;
        padding: 8px 12px;
        cursor: pointer;
        margin: 8px;
        font-weight: 600;
      }

      .btn:hover { background: #20ba5a; }

      @media (max-width: 600px) {
        header { padding: 8px 12px; }
        .logo-wrap img { height: 44px; }
        .cart-btn { width: 40px; height: 40px; font-size: 20px; }
        .grid { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); }
      }
    </style>
  </head>

  <body>
    <!-- React Mount Point -->
    <div id="root"></div>

    <!-- React Libraries -->
    <script defer crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script defer crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Main App Script (your original React logic, unchanged) -->
    <script>
      (function(){
        const { useState, useEffect } = React;

        const SHEET_URL = 'https://script.google.com/macros/s/AKfycbxENH68uAePu7ORZJawjjXVqvTJfXB8gpBVNfizrdOmyURo8vu4edhr7h9BDc1SdSxlEg/exec';
        const WHATSAPP_NUMBER_WITHOUT_PLUS = '919978653852';
        const DRIVE_UPLOAD_URL = 'https://script.google.com/macros/s/AKfycbzQFujhLNbFusQfPxsHgQfoXAwcQz-caWSs0JAZDR9VdqEWY_PdKNIDi6ELvFQK03LG/exec';

        async function fetchSheet() {
          const res = await fetch(SHEET_URL);
          const json = await res.json();
          if (!json || !json.data) return [];
          return json.data.map(row => ({ ...row }));
        }

        function normalizeImageUrl(cell) {
          if (!cell) return '';
          let val = String(cell);
          if (val.includes(',')) val = val.split(',')[0].trim();
          if (val.includes('\n')) val = val.split('\n')[0].trim();
          if (val.includes('raw.githubusercontent.com')) return val;
          if (val.includes('github.com') && val.includes('/blob/')) {
            return val.replace('https://github.com/', 'https://raw.githubusercontent.com/').replace('/blob/', '/');
          }
          if (val.includes('drive.google.com/open?id=')) {
            const id = val.split('id=')[1].split('&')[0];
            return `https://drive.google.com/uc?export=view&id=${id}`;
          }
          if (val.includes('drive.google.com/file/d/')) {
            const id = val.split('/d/')[1].split('/')[0];
            return `https://drive.google.com/uc?export=view&id=${id}`;
          }
          if (val.includes('drive.google.com/uc?export=view')) return val;
          return val;
        }

        function App() {
          const [products, setProducts] = useState([]);
          const [filtered, setFiltered] = useState([]);
          const [categories, setCategories] = useState([]);
          const [q, setQ] = useState('');
          const [cat, setCat] = useState('All');
          const [cartOpen, setCartOpen] = useState(false);
          const [cart, setCart] = useState(() => {
            try { return JSON.parse(localStorage.getItem('yf_cart') || '[]'); } catch(e) { return []; }
          });

          useEffect(() => {
            let mounted = true;
            fetchSheet().then(rows => {
              if (!mounted) return;
              const normalized = rows.map(r => {
                const imageCell = r.Pimage || r.pimage || r.Image || '';
                return {
                  category: (r.Category || '').toString(),
                  pname: (r.Pname || '').toString(),
                  pdesc: (r.Pdesc || '').toString(),
                  psize: (r.Psize || '').toString(),
                  prate: (r.Prate || '0').toString(),
                  pimage: normalizeImageUrl(imageCell)
                };
              });
              setProducts(normalized);
              setFiltered(normalized);
              const cats = Array.from(new Set(normalized.map(x => x.category || 'Uncategorized')));
              setCategories(['All', ...cats]);
            });
            return () => { mounted = false };
          }, []);

          useEffect(() => {
            localStorage.setItem('yf_cart', JSON.stringify(cart));
          }, [cart]);

          useEffect(() => {
            const out = products.filter(d => {
              const matchesQ = !q || (d.pname && d.pname.toLowerCase().includes(q.toLowerCase()));
              const matchesCat = (cat === 'All') || (d.category === cat);
              return matchesQ && matchesCat;
            });
            setFiltered(out);
          }, [products, q, cat]);

          function addToCart(item) {
            const idx = cart.findIndex(c => c.pname === item.pname);
            if (idx > -1) {
              const copy = [...cart];
              copy[idx].qty += 1;
              setCart(copy);
            } else {
              setCart([...cart, { ...item, qty: 1 }]);
            }
          }

          function changeQty(item, delta) {
            setCart(cart.map(c => c === item ? { ...c, qty: Math.max(1, c.qty + delta) } : c));
          }

          function removeFromCart(item) {
            setCart(cart.filter(c => c !== item));
          }

          return React.createElement('div', null,
            // âœ… Header inside React (live cart count)
            React.createElement('header', null,
              React.createElement('div', { className: 'logo-wrap' },
                React.createElement('img', {
                  src: 'https://raw.githubusercontent.com/yesfashionhub/yesfashionhub.github.io/main/cropped-yes-lOGO.webp',
                  alt: 'Logo'
                })
              ),
              React.createElement('div', { className: 'cart-wrap' },
                React.createElement('button', { className: 'cart-btn', onClick: () => setCartOpen(true) }, 'ðŸ›ï¸'),
                React.createElement('span', { id: 'cartCount', className: 'cart-count' },
                  cart.reduce((s, i) => s + i.qty, 0)
                )
              )
            ),

            // âœ… Filters below header
            React.createElement('div', { className: 'controls' },
              React.createElement('input', {
                type: 'text',
                placeholder: 'Search products...',
                value: q,
                onChange: e => setQ(e.target.value)
              }),
              React.createElement('select', {
                value: cat,
                onChange: e => setCat(e.target.value)
              },
                categories.map(c => React.createElement('option', { key: c, value: c }, c))
              )
            ),

            // âœ… Product grid
            React.createElement('div', { className: 'grid' },
              filtered.map((p, idx) =>
                React.createElement('div', { className: 'card', key: idx },
                  React.createElement('img', { src: p.pimage || 'https://via.placeholder.com/400x300?text=No+Image', alt: p.pname }),
                  React.createElement('h3', null, p.pname),
                  React.createElement('p', null, p.pdesc),
                  React.createElement('p', null, 'Size: ' + (p.psize || '-')),
                  React.createElement('p', null, 'â‚¹' + (p.prate || '-')),
                  React.createElement('button', { className: 'btn', onClick: () => addToCart(p) }, 'Add to cart')
                )
              )
            ),

            // âœ… Cart modal
            cartOpen && React.createElement('div', { className: 'modal' },
              React.createElement('div', { className: 'modal-content' },
                React.createElement('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center' } },
                  React.createElement('h3', null, 'Your Cart'),
                  React.createElement('div', null,
                    React.createElement('button', { className: 'btn', onClick: () => alert('Order confirm flow same as before!') }, 'Confirm Final Order'),
                    ' ',
                    React.createElement('button', { className: 'btn', onClick: () => setCartOpen(false) }, 'Close')
                  )
                ),
                cart.length === 0 ? React.createElement('div', null, 'Cart is empty') :
                  React.createElement('div', null,
                    cart.map((c, i) =>
                      React.createElement('div', { className: 'cart-row', key: i },
                        React.createElement('img', { src: c.pimage || 'https://via.placeholder.com/80', alt: c.pname }),
                        React.createElement('div', { style: { flex: 1 } },
                          React.createElement('div', { style: { fontWeight: 600 } }, c.pname),
                          React.createElement('div', null, 'â‚¹' + c.prate + ' x ' + c.qty)
                        ),
                        React.createElement('div', null,
                          React.createElement('button', { className: 'qty-btn', onClick: () => changeQty(c, 1) }, '+'),
                          React.createElement('button', { className: 'qty-btn', onClick: () => changeQty(c, -1) }, '-'),
                          React.createElement('button', { className: 'qty-btn', onClick: () => removeFromCart(c) }, 'Remove')
                        )
                      )
                    ),
                    React.createElement('div', { style: { textAlign: 'right', fontWeight: 700, marginTop: 10 } },
                      `Total: â‚¹${cart.reduce((s, i) => s + (Number(i.prate || 0) * Number(i.qty || 1)), 0)}`
                    )
                  )
              )
            )
          );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
      })();
    </script>
  </body>
</html>
