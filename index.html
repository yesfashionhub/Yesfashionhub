<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>YesFashionHub - WhatsApp Store</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <meta http-equiv="Cache-Control" content="public, max-age=31536000">

    <!-- html2canvas for cart snapshot -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

    <style>
      * { box-sizing: border-box; }
      body {
        font-family: 'Inter', system-ui, Arial;
        margin: 0;
        background: #e5ddd5;
        overflow-x: hidden;
      }

      header {
        background: #25D366;
        color: #fff;
        padding: 10px 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: sticky;
        top: 0;
        z-index: 1000;
        box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      }

      .logo-wrap img {
        height: 90px;
        width: auto;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(255,255,255,0.8),
                    0 2px 6px rgba(0,0,0,0.25);
        background: rgba(255,255,255,0.15);
        padding: 4px;
      }

      .cart-wrap { position: relative; }
      .cart-btn {
        background: #128C7E;
        border: none;
        border-radius: 50%;
        width: 44px; height: 44px;
        font-size: 22px; color: #fff;
        cursor: pointer;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      }
      .cart-count {
        position: absolute;
        top: -6px; right: -6px;
        background: #ff3b30; color: #fff;
        border-radius: 50%; font-size: 12px;
        padding: 3px 6px;
      }

      .controls {
        background: #fff;
        display: flex; flex-direction: column;
        gap: 8px; padding: 12px;
      }
      .controls input, .controls select {
        padding: 10px; border: 1px solid #ccc;
        border-radius: 8px; font-size: 15px;
        width: 100%;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 12px; padding: 12px;
      }

      .card {
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        overflow: hidden;
        display: flex; flex-direction: column;
        transition: transform 0.2s ease;
      }
      .card:hover { transform: scale(1.02); }
      .card img {
        width: 100%; height: 160px; object-fit: cover;
      }
      .card h3 { margin: 10px 8px 0; font-size: 16px; color: #222; }
      .card p { margin: 4px 8px; font-size: 14px; color: #555; }
      .btn {
        background: #25D366; color: #fff;
        border: none; border-radius: 6px;
        padding: 8px 12px; cursor: pointer;
        margin: 8px; font-weight: 600;
      }
      .btn:hover { background: #20ba5a; }

      .modal {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.5);
        display: flex; justify-content: center; align-items: center;
        z-index: 2000;
      }
      .modal-content {
        background: #fff;
        border-radius: 10px;
        padding: 16px;
        width: 90%;
        max-width: 500px;
        max-height: 80vh;
        overflow-y: auto;
      }
      .cart-row {
        display: flex; gap: 8px;
        align-items: center;
        margin: 8px 0;
        border-bottom: 1px solid #ddd;
        padding-bottom: 8px;
      }
      .cart-row img {
        width: 60px; height: 60px; object-fit: cover; border-radius: 8px;
      }
      .qty-btn {
        margin: 2px;
        background: #eee;
        border: none;
        border-radius: 4px;
        padding: 4px 8px;
        cursor: pointer;
      }
    </style>
  </head>

  <body>
    <header>
      <div class="logo-wrap">
        <img src="https://raw.githubusercontent.com/yesfashionhub/yesfashionhub.github.io/main/cropped-yes-lOGO.webp" alt="Logo" />
      </div>
      <div class="cart-wrap">
        <button id="openCartBtn" class="cart-btn">üõçÔ∏è</button>
        <span id="cartCount" class="cart-count">0</span>
      </div>
    </header>

    <div class="controls">
      <input type="text" id="searchBox" placeholder="Search products..." />
      <select id="categoryFilter">
        <option value="">All Categories</option>
        <option value="Men">Men</option>
        <option value="Women">Women</option>
        <option value="Kids">Kids</option>
      </select>
    </div>

    <div id="productGrid" class="grid"></div>
    <div id="root"></div>

    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <script>
    (function(){
      const { useState, useEffect } = React;
      const SHEET_URL = 'https://script.google.com/macros/s/AKfycbxENH68uAePu7ORZJawjjXVqvTJfXB8gpBVNfizrdOmyURo8vu4edhr7h9BDc1SdSxlEg/exec';
      const DRIVE_UPLOAD_URL = 'https://script.google.com/macros/s/AKfycbzQFujhLNbFusQfPxsHgQfoXAwcQz-caWSs0JAZDR9VdqEWY_PdKNIDi6ELvFQK03LG/exec';
      const WHATSAPP_NUMBER_WITHOUT_PLUS = '919978653852';

      async function fetchSheet() {
        const res = await fetch(SHEET_URL);
        const json = await res.json();
        return json.data || [];
      }

      function normalizeImageUrl(cell) {
        if (!cell) return '';
        let val = String(cell);
        if (val.includes(',')) val = val.split(',')[0].trim();
        if (val.includes('\n')) val = val.split('\n')[0].trim();
        if (val.includes('raw.githubusercontent.com')) return val;
        if (val.includes('github.com') && val.includes('/blob/'))
          return val.replace('https://github.com/','https://raw.githubusercontent.com/').replace('/blob/','/');
        if (val.includes('drive.google.com/file/d/')) {
          const id = val.split('/d/')[1].split('/')[0];
          return `https://drive.google.com/uc?export=view&id=${id}`;
        }
        return val;
      }

      function App(){
        const [products, setProducts] = useState([]);
        const [filtered, setFiltered] = useState([]);
        const [cartOpen, setCartOpen] = useState(false);
        const [cart, setCart] = useState(()=>JSON.parse(localStorage.getItem('yf_cart')||'[]'));

        useEffect(()=>{ fetchSheet().then(rows=>{
          const normalized = rows.map(r=>({
            category:r.Category||r.category||'',
            pname:r.Pname||r.pname||r.Product||'',
            pdesc:r.Pdesc||r.pdesc||'',
            psize:r.Psize||r.psize||'',
            prate:r.Prate||r.prate||r.Price||'0',
            pimage:normalizeImageUrl(r.Pimage||r.pimage||r.Image||'')
          }));
          setProducts(normalized); setFiltered(normalized);
        }); },[]);

        useEffect(()=>{
          localStorage.setItem('yf_cart', JSON.stringify(cart));
          const badge = document.getElementById('cartCount');
          if (badge) badge.textContent = cart.reduce((s,i)=>s+(+i.qty||0),0);
        }, [cart]);

        useEffect(()=>{
          document.getElementById('openCartBtn').onclick = ()=>setCartOpen(true);
        },[]);

        function addToCart(p){
          const key = `${p.pname}||${p.pimage}||${p.psize}`;
          const idx = cart.findIndex(c => c._key === key);
          if (idx > -1) {
            const copy = [...cart]; copy[idx].qty += 1; setCart(copy);
          } else setCart([...cart, {...p, qty:1, _key:key}]);
          const t=document.createElement('div');
          Object.assign(t.style,{position:'fixed',bottom:'20px',left:'50%',transform:'translateX(-50%)',background:'#25D366',color:'#fff',padding:'8px 14px',borderRadius:'8px',fontWeight:'700',zIndex:9999});
          t.textContent='‚úÖ Added to cart'; document.body.appendChild(t); setTimeout(()=>t.remove(),1200);
        }

        function changeQty(it,delta){setCart(cart.map(c=>c===it?{...c,qty:Math.max(1,c.qty+delta)}:c));}
        function removeFromCart(it){setCart(cart.filter(c=>c!==it));}

            // ‚úÖ NEW CHECKOUT FUNCTION ‚Äî creates actual JPG and uploads correctly
async function confirmFinalOrder() {
  if (cart.length === 0) {
    alert('Cart empty');
    return;
  }

  // üîπ Ask user details
  const custName = prompt('Enter your name:');
  if (!custName) return alert('Name required');
  const custCity = prompt('Enter your city:');
  if (!custCity) return alert('City required');

  // üîπ Show loading overlay
  const overlay = document.createElement('div');
  overlay.id = 'loadingOverlay';
  overlay.style.position = 'fixed';
  overlay.style.inset = '0';
  overlay.style.background = 'rgba(0,0,0,0.6)';
  overlay.style.display = 'flex';
  overlay.style.flexDirection = 'column';
  overlay.style.justifyContent = 'center';
  overlay.style.alignItems = 'center';
  overlay.style.zIndex = 6000;
  overlay.innerHTML = `
    <div style="color:#fff;font-size:20px;font-weight:700;margin-bottom:12px;">‚è≥ Creating Order Image...</div>
    <div style="width:64px;height:64px;border:6px solid rgba(255,255,255,0.2);border-top-color:#25D366;border-radius:50%;animation:spin 1s linear infinite;"></div>
    <style>@keyframes spin{0%{transform:rotate(0);}100%{transform:rotate(360deg);}}</style>
  `;
  document.body.appendChild(overlay);

  try {
    // üîπ Use html2canvas to capture cart modal as image
    const cartEl = document.querySelector('.modal-content');
    if (!cartEl) {
      alert('Cart not visible for capture');
      overlay.remove();
      return;
    }

    // Load html2canvas if not already loaded
    if (!window.html2canvas) {
      await new Promise((res) => {
        const s = document.createElement('script');
        s.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
        s.onload = res;
        document.body.appendChild(s);
      });
    }

    const canvas = await html2canvas(cartEl, { backgroundColor: '#fff', scale: 2 });
    const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
    const base64 = dataUrl.split(',')[1];

    // üîπ Upload image to Drive
    const filename = `Order_${custName}_${Date.now()}.jpg`;
    const res = await fetch(DRIVE_UPLOAD_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({ file: base64, filename })
    });

    const json = await res.json();
    if (!json.success) throw new Error(json.error || 'Upload failed');

    // üîπ WhatsApp message with image link
    const msg = `üõçÔ∏è *YES FASHION HUB NEW ORDER*\n\nüë§ Name: ${custName}\nüèôÔ∏è City: ${custCity}\n\nView order image:\n${json.link}`;
    window.open(`https://wa.me/${WHATSAPP_NUMBER_WITHOUT_PLUS}?text=${encodeURIComponent(msg)}`, '_blank');

    alert('‚úÖ Order image uploaded successfully!');
    setCart([]);
    setCartOpen(false);
  } catch (err) {
    console.error('Error creating image:', err);
    alert('‚ùå Error creating/uploading image.');
  } finally {
    const ov = document.getElementById('loadingOverlay');
    if (ov) ov.remove();
  }
  }

        return React.createElement('div',null,
          React.createElement('div',{className:'grid'},
            filtered.map((p,idx)=>
              React.createElement('div',{className:'card',key:idx},
                React.createElement('img',{src:p.pimage||'https://via.placeholder.com/400x300?text=No+Image',alt:p.pname}),
                React.createElement('h3',null,p.pname),
                React.createElement('p',null,p.pdesc),
                React.createElement('p',null,'Size: '+p.psize),
                React.createElement('p',null,'‚Çπ'+p.prate),
                React.createElement('button',{className:'btn',onClick:()=>addToCart(p)},'Add to Cart')
              )
            )
          ),
          cartOpen && React.createElement('div',{className:'modal'},
            React.createElement('div',{className:'modal-content'},
              React.createElement('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center'}},
                React.createElement('h3',null,'Your Cart'),
                React.createElement('div',null,
                  React.createElement('button',{className:'btn',onClick:confirmFinalOrder},'Checkout'),
                  ' ',
                  React.createElement('button',{className:'btn',onClick:()=>setCartOpen(false)},'Close')
                )
              ),
              cart.length===0 ? React.createElement('div',null,'Cart is empty') :
              React.createElement('div',null,
                cart.map((c,i)=>
                  React.createElement('div',{className:'cart-row',key:i},
                    React.createElement('img',{src:c.pimage||'https://via.placeholder.com/80',alt:c.pname}),
                    React.createElement('div',{style:{flex:1}},
                      React.createElement('div',{style:{fontWeight:600}},c.pname),
                      React.createElement('div',null,'‚Çπ'+c.prate+' x '+c.qty)
                    ),
                    React.createElement('div',null,
                      React.createElement('button',{className:'qty-btn',onClick:()=>changeQty(c,-1)},'-'),
                      React.createElement('button',{className:'qty-btn',onClick:()=>changeQty(c,1)},'+'),
                      React.createElement('button',{className:'qty-btn',onClick:()=>removeFromCart(c)},'‚úñ')
                    )
                  )
                )
              )
            )
          )
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
    })();
    </script>
  </body>
</html>
