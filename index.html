<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>YesFashionHub - WhatsApp Store</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <meta http-equiv="Cache-Control" content="public, max-age=31536000">

    <style>
      * { box-sizing: border-box; }
      body {
        font-family: 'Inter', system-ui, Arial;
        margin: 0;
        background: #e5ddd5;
        overflow-x: hidden;
      }

      header {
        background: #25D366;
        color: #fff;
        padding: 10px 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: sticky;
        top: 0;
        z-index: 1000;
        box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      }

      .logo-wrap img {
        height: 90px;
        width: auto;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(255,255,255,0.8),
                    0 2px 6px rgba(0,0,0,0.25);
        background: rgba(255,255,255,0.15);
        padding: 4px;
      }

      .cart-wrap { position: relative; }
      .cart-btn {
        background: #128C7E;
        border: none;
        border-radius: 50%;
        width: 44px; height: 44px;
        font-size: 22px; color: #fff;
        cursor: pointer;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        transition: transform 0.2s ease, background-color 0.3s;
      }
      .cart-btn:hover { transform: scale(1.1); background: #20ba5a; }
      .cart-count {
        position: absolute;
        top: -6px; right: -6px;
        background: #ff3b30; color: #fff;
        border-radius: 50%; font-size: 12px;
        padding: 3px 6px;
      }

      .controls {
        background: #fff;
        display: flex; flex-direction: column;
        gap: 8px; padding: 12px;
      }
      .controls input, .controls select {
        padding: 10px; border: 1px solid #ccc;
        border-radius: 8px; font-size: 15px;
        width: 100%;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 12px; padding: 12px;
      }

      .card {
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        overflow: hidden;
        display: flex; flex-direction: column;
        transition: transform 0.2s ease;
      }
      .card:hover { transform: scale(1.02); }
      .card img {
        width: 100%; height: 160px; object-fit: cover;
      }
      .card h3 { margin: 10px 8px 0; font-size: 16px; color: #222; }
      .card p { margin: 4px 8px; font-size: 14px; color: #555; }
      .btn {
        background: #25D366; color: #fff;
        border: none; border-radius: 6px;
        padding: 8px 12px; cursor: pointer;
        margin: 8px; font-weight: 600;
      }
      .btn:hover { background: #20ba5a; }

      .modal {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.5);
        display: flex; justify-content: center; align-items: center;
        z-index: 2000;
      }
      .modal-content {
        background: #fff;
        border-radius: 10px;
        padding: 16px;
        width: 90%;
        max-width: 500px;
        max-height: 80vh;
        overflow-y: auto;
      }
      .cart-row {
        display: flex; gap: 8px;
        align-items: center;
        margin: 8px 0;
        border-bottom: 1px solid #ddd;
        padding-bottom: 8px;
      }
      .cart-row img {
        width: 60px; height: 60px; object-fit: cover; border-radius: 8px;
      }
      .qty-btn {
        margin: 2px;
        background: #eee;
        border: none;
        border-radius: 4px;
        padding: 4px 8px;
        cursor: pointer;
      }

      @media (max-width:600px){
        header{padding:8px 12px;}
        .logo-wrap img{height:44px;}
        .cart-btn{width:40px;height:40px;font-size:20px;}
        .grid{grid-template-columns:repeat(auto-fill,minmax(140px,1fr));}
      }
    </style>
  </head>

  <body>
    <header>
      <div class="logo-wrap">
        <img src="https://raw.githubusercontent.com/yesfashionhub/yesfashionhub.github.io/main/cropped-yes-lOGO.webp" alt="Logo" />
      </div>
      <div class="cart-wrap">
        <button id="openCartBtn" class="cart-btn">üõçÔ∏è</button>
        <span id="cartCount" class="cart-count">0</span>
      </div>
    </header>

    <div class="controls">
      <input type="text" id="searchBox" placeholder="Search products..." />
      <select id="categoryFilter">
        <option value="">All Categories</option>
        <option value="Men">Men</option>
        <option value="Women">Women</option>
        <option value="Kids">Kids</option>
      </select>
    </div>

    <div id="productGrid" class="grid"></div>
    <div id="root"></div>

    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
    (function(){
      const { useState, useEffect } = React;

      const SHEET_URL = 'https://script.google.com/macros/s/AKfycbxENH68uAePu7ORZJawjjXVqvTJfXB8gpBVNfizrdOmyURo8vu4edhr7h9BDc1SdSxlEg/exec';
      const WHATSAPP_NUMBER_WITHOUT_PLUS = '919978653852';
      const DRIVE_UPLOAD_URL = 'https://script.google.com/macros/s/AKfycbzQFujhLNbFusQfPxsHgQfoXAwcQz-caWSs0JAZDR9VdqEWY_PdKNIDi6ELvFQK03LG/exec';

      async function fetchSheet() {
        const res = await fetch(SHEET_URL);
        const json = await res.json();
        return json.data || [];
      }

      function normalizeImageUrl(cell) {
        if (!cell) return '';
        let val = String(cell);
        if (val.includes(',')) val = val.split(',')[0].trim();
        if (val.includes('\n')) val = val.split('\n')[0].trim();
        if (val.includes('raw.githubusercontent.com')) return val;
        if (val.includes('github.com') && val.includes('/blob/'))
          return val.replace('https://github.com/', 'https://raw.githubusercontent.com/').replace('/blob/', '/');
        if (val.includes('drive.google.com/file/d/')) {
          const id = val.split('/d/')[1].split('/')[0];
          return `https://drive.google.com/uc?export=view&id=${id}`;
        }
        return val;
      }

        function App(){
          const [products, setProducts] = useState([]);
          const [filtered, setFiltered] = useState([]);
          const [q, setQ] = useState('');
          const [cat, setCat] = useState('All');
          const [cartOpen, setCartOpen] = useState(false);
          const [cart, setCart] = useState(()=>JSON.parse(localStorage.getItem('yf_cart')||'[]'));
        
          useEffect(()=>{ fetchSheet().then(rows=>{
            const normalized = rows.map(r=>({
              category: r.Category||r.category||'',
              pname: r.Pname||r.pname||r.Product||'',
              pdesc: r.Pdesc||r.pdesc||'',
              psize: r.Psize||r.psize||'',
              prate: r.Prate||r.prate||r.Price||'0',
              pimage: normalizeImageUrl(r.Pimage||r.pimage||r.Image||'')
            }));
            setProducts(normalized); setFiltered(normalized);
          }); },[]);
        
          // ‚úÖ Persist + Update badge count
          useEffect(()=>{
            localStorage.setItem('yf_cart',JSON.stringify(cart));
            const badge = document.getElementById('cartCount');
            if (badge) badge.textContent = cart.length;  // update red badge count
          },[cart]);
        
          useEffect(()=>{
            const btn=document.getElementById('openCartBtn');
            btn.onclick=()=>setCartOpen(true);
          },[]);
        
          // ‚úÖ Modified addToCart with success message
          function addToCart(p){
            const idx=cart.findIndex(c=>c.pname===p.pname);
            if(idx>-1){
              const copy=cart.slice();
              copy[idx].qty+=1;
              setCart(copy);
            } else {
              setCart([...cart,{...p,qty:1}]);
            }
            // success feedback (quick toast style)
            const btn = document.createElement('div');
            btn.textContent = '‚úÖ Added to cart!';
            btn.style.position='fixed';
            btn.style.bottom='20px';
            btn.style.left='50%';
            btn.style.transform='translateX(-50%)';
            btn.style.background='#25D366';
            btn.style.color='#fff';
            btn.style.padding='8px 16px';
            btn.style.borderRadius='8px';
            btn.style.fontWeight='600';
            btn.style.boxShadow='0 2px 8px rgba(0,0,0,0.3)';
            btn.style.zIndex='3000';
            document.body.appendChild(btn);
            setTimeout(()=>btn.remove(),1500);
          }
     
          function changeQty(it,delta){setCart(cart.map(c=>c===it?{...c,qty:Math.max(1,c.qty+delta)}:c));}
          function removeFromCart(it){setCart(cart.filter(c=>c!==it));}

          // Confirm Final Order: generate PDF, upload to Drive, get link, open WhatsApp
          async function confirmFinalOrder() {
            if (cart.length === 0) {
              alert("Cart empty");
              return;
            }
          
            // üîπ Show processing overlay
            const overlay = document.createElement("div");
            overlay.id = "loadingOverlay";
            overlay.style.position = "fixed";
            overlay.style.top = 0;
            overlay.style.left = 0;
            overlay.style.width = "100%";
            overlay.style.height = "100%";
            overlay.style.background = "rgba(0,0,0,0.6)";
            overlay.style.color = "#fff";
            overlay.style.display = "flex";
            overlay.style.flexDirection = "column";
            overlay.style.justifyContent = "center";
            overlay.style.alignItems = "center";
            overlay.style.zIndex = "5000";
            overlay.innerHTML = `
              <div style="font-size:22px;font-weight:600;margin-bottom:12px;">‚è≥ Generating Order PDF...</div>
              <div class="loader" style="border:6px solid #ccc;border-top:6px solid #25D366;border-radius:50%;width:60px;height:60px;animation:spin 1s linear infinite;"></div>
              <style>@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}</style>
            `;
            document.body.appendChild(overlay);
          
            try {
              const { jsPDF } = window.jspdf;
              const doc = new jsPDF({ unit: "pt", format: "a4" });
              let y = 60;
          
              // Header
              doc.setFontSize(20);
              doc.setFont("helvetica", "bold");
              doc.text("üõçÔ∏è Yes Fashion Hub", 40, y);
              y += 20;
              doc.setFontSize(12);
              doc.setFont("helvetica", "normal");
              doc.text("Order Confirmation Slip", 40, y);
              y += 30;
          
              // Table header
              doc.setFontSize(11);
              doc.setFont("helvetica", "bold");
              doc.text("No.", 40, y);
              doc.text("Product Name", 70, y);
              doc.text("Size", 260, y);
              doc.text("Rate √ó Qty", 340, y);
              doc.text("Total (‚Çπ)", 460, y);
              y += 10;
              doc.line(40, y, 540, y);
              y += 15;
          
              let total = 0;
          
              // Table rows
              for (let i = 0; i < cart.length; i++) {
                const item = cart[i];
                const rate = Number(item.prate || 0);
                const qty = Number(item.qty || 1);
                const rowTotal = rate * qty;
                total += rowTotal;
          
                doc.setFont("helvetica", "normal");
                doc.text(String(i + 1), 40, y);
                doc.text(String(item.pname || "-"), 70, y, { maxWidth: 180 });
                doc.text(String(item.psize || "-"), 260, y);
                doc.text(`‚Çπ${rate} √ó ${qty}`, 340, y);
                doc.text(`‚Çπ${rowTotal}`, 460, y);
          
                // üîπ Bigger image 60√ó60
                if (item.pimage && y < 700) {
                  try {
                    const resp = await fetch(item.pimage, { mode: "cors" });
                    const blob = await resp.blob();
                    const dataUrl = await new Promise((res, rej) => {
                      const reader = new FileReader();
                      reader.onload = () => res(reader.result);
                      reader.onerror = rej;
                      reader.readAsDataURL(blob);
                    });
                    doc.addImage(dataUrl, "JPEG", 520, y - 20, 60, 60);
                  } catch {}
                }
          
                y += 25;
                if (y > 720) {
                  doc.addPage();
                  y = 60;
                }
              }
          
              // Grand Total
              y += 10;
              doc.line(40, y, 540, y);
              y += 20;
              doc.setFont("helvetica", "bold");
              doc.text(`Grand Total: ‚Çπ${total}`, 400, y);
          
              // Footer
              y += 40;
              doc.setFontSize(10);
              doc.setFont("helvetica", "italic");
              doc.text("Thank you for shopping with Yes Fashion Hub!", 40, y);
              y += 14;
              doc.text("For queries, contact us on WhatsApp.", 40, y);
          
              // Convert PDF to base64
              const pdfBlob = doc.output("blob");
              const base64 = await new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result.split(",")[1]);
                reader.onerror = reject;
                reader.readAsDataURL(pdfBlob);
              });
          
              // Upload to Drive
              const filename = `Order_${Date.now()}.pdf`;
              const res = await fetch(DRIVE_UPLOAD_URL, {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: new URLSearchParams({ file: base64, filename }),
              });
          
              const json = await res.json();
              if (!json || !json.success) {
                alert("Upload failed. Please try again.");
                return;
              }
          
              // WhatsApp message
              const link = json.link;
              let msgPlain = `üõçÔ∏è Yes Fashion Hub - New Order\n\n`;
              cart.forEach((c, i) => {
                msgPlain += `${i + 1}. ${c.pname} | Qty: ${c.qty} | ‚Çπ${c.prate}\n`;
              });
              msgPlain += `\nTotal: ‚Çπ${total}\n\nOrder PDF: ${link}\n\nPlease confirm.`;
          
              const waUrl = `https://wa.me/${WHATSAPP_NUMBER_WITHOUT_PLUS}?text=${encodeURIComponent(msgPlain)}`;
              window.open(waUrl, "_blank");
          
              alert("‚úÖ Order uploaded successfully!");
              
              // üîπ Clear cart after order
              setCart([]);
              setCartOpen(false);
          
            } catch (err) {
              console.error("confirmFinalOrder error", err);
              alert("Error creating/uploading order. See console.");
            } finally {
              // üîπ Hide loader
              const overlay = document.getElementById("loadingOverlay");
              if (overlay) overlay.remove();
            }
          }


          

          return React.createElement('div',null,
          React.createElement('div',{className:'grid'},
            filtered.map((p,idx)=>
              React.createElement('div',{className:'card',key:idx},
                React.createElement('img',{src:p.pimage||'https://via.placeholder.com/400x300?text=No+Image',alt:p.pname}),
                React.createElement('h3',null,p.pname),
                React.createElement('p',null,p.pdesc),
                React.createElement('p',null,'Size: '+p.psize),
                React.createElement('p',null,'‚Çπ'+p.prate),
                React.createElement('button',{className:'btn',onClick:()=>addToCart(p)},'Add to Cart')
              )
            )
          ),
          cartOpen && React.createElement('div',{className:'modal'},
            React.createElement('div',{className:'modal-content'},
              React.createElement('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center'}},
                React.createElement('h3',null,'Your Cart'),
                React.createElement('div',null,
                  React.createElement('button',{className:'btn',onClick:confirmFinalOrder},'Confirm Final Order'),
                  ' ',
                  React.createElement('button',{className:'btn',onClick:()=>setCartOpen(false)},'Close')
                )
              ),
              cart.length===0 ? React.createElement('div',null,'Cart is empty') :
              React.createElement('div',null,
                cart.map((c,i)=>
                  React.createElement('div',{className:'cart-row',key:i},
                    React.createElement('img',{src:c.pimage||'https://via.placeholder.com/80',alt:c.pname}),
                    React.createElement('div',{style:{flex:1}},
                      React.createElement('div',{style:{fontWeight:600}},c.pname),
                      React.createElement('div',null,'‚Çπ'+c.prate+' x '+c.qty)
                    ),
                    React.createElement('div',null,
                      React.createElement('button',{className:'qty-btn',onClick:()=>changeQty(c,1)},'+'),
                      React.createElement('button',{className:'qty-btn',onClick:()=>changeQty(c,-1)},'-'),
                      React.createElement('button',{className:'qty-btn',onClick:()=>removeFromCart(c)},'Remove')
                    )
                  )
                ),
                React.createElement('div',{style:{textAlign:'right',fontWeight:700,marginTop:10}},`Total: ‚Çπ${cart.reduce((s,i)=>s+(+i.prate*i.qty),0)}`)
              )
            )
          )
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
    })();
    </script>
  </body>
</html>
