<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>YesFashionHub - Checkout Image Share</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <meta http-equiv="Cache-Control" content="public, max-age=31536000">

    <!-- html2canvas for snapshot -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

    <style>
      * { box-sizing: border-box; }
      body { font-family: 'Inter', system-ui, Arial; margin:0; background:#e5ddd5; overflow-x:hidden; }

      /* Header */
      header {
        background:#25D366; color:#fff;
        padding:10px 16px; position:sticky; top:0; z-index:1000;
        display:flex; align-items:center; justify-content:space-between;
        box-shadow:0 2px 6px rgba(0,0,0,0.12);
      }
      .logo-wrap img { height:60px; width:auto; border-radius:8px; box-shadow:0 0 10px rgba(255,255,255,0.85),0 2px 6px rgba(0,0,0,0.18); background:rgba(255,255,255,0.12); padding:4px; }
      .cart-wrap { position:relative; }
      .cart-btn { background:#128C7E; border:none; border-radius:50%; width:44px; height:44px; font-size:20px; color:#fff; cursor:pointer; }
      .cart-count { position:absolute; top:-6px; right:-6px; background:#ff3b30; color:#fff; border-radius:50%; font-size:12px; padding:3px 6px; }

      /* Controls */
      .controls { background:#fff; display:flex; flex-direction:column; gap:8px; padding:12px; }
      .controls input, .controls select { padding:10px; border:1px solid #ccc; border-radius:8px; font-size:15px; width:100%; }

      /* Grid */
      .grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:12px; padding:12px; }
      .card { background:#fff; border-radius:10px; box-shadow:0 1px 4px rgba(0,0,0,0.08); overflow:hidden; display:flex; flex-direction:column; transition:transform .15s ease; }
      .card:hover{ transform:scale(1.02); }
      .card img { width:100%; height:160px; object-fit:cover; }
      .card h3 { margin:10px 8px 0; font-size:16px; color:#222; }
      .card p { margin:4px 8px; font-size:14px; color:#555; }
      .btn { background:#25D366; color:#fff; border:none; border-radius:6px; padding:8px 12px; cursor:pointer; margin:8px; font-weight:600; }
      .btn:hover { background:#20ba5a; }

      /* Modal (cart) */
      .modal { position:fixed; inset:0; background:rgba(0,0,0,0.45); display:flex; align-items:center; justify-content:center; z-index:2000; }
      .modal-content { background:#fff; border-radius:10px; padding:16px; width:96%; max-width:720px; max-height:88vh; overflow:auto; }
      .cart-row { display:flex; gap:10px; align-items:center; border-bottom:1px solid #eee; padding:8px 0; }
      .cart-row img { width:70px; height:70px; object-fit:cover; border-radius:8px; }
      .qty-btn { margin:2px; padding:6px 8px; border-radius:6px; border:1px solid #ddd; background:#fff; cursor:pointer; }

      /* Checkout modal (name/city) */
      .checkout-modal { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:3000; background:rgba(0,0,0,0.5); }
      .checkout-card { background:#fff; padding:18px; border-radius:10px; width:92%; max-width:420px; box-shadow:0 8px 30px rgba(0,0,0,0.2); }

      /* Loading overlay */
      #loadingOverlay { position:fixed; inset:0; background:rgba(0,0,0,0.6); color:#fff; display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:4000; }
      .spinner { width:64px; height:64px; border:6px solid rgba(255,255,255,0.2); border-top-color:#25D366; border-radius:50%; animation:spin 1s linear infinite; margin-bottom:12px; }
      @keyframes spin {0%{transform:rotate(0)}100%{transform:rotate(360deg)}}

      @media (max-width:600px) {
        .logo-wrap img { height:44px; }
        .grid { grid-template-columns:repeat(auto-fill,minmax(140px,1fr)); }
      }
    </style>
  </head>

  <body>
    <header>
      <div class="logo-wrap">
        <img src="https://raw.githubusercontent.com/yesfashionhub/yesfashionhub.github.io/main/cropped-yes-lOGO.webp" alt="Logo" />
      </div>
      <div class="cart-wrap">
        <button id="openCartBtn" class="cart-btn">🛒</button>
        <span id="cartCount" class="cart-count">0</span>
      </div>
    </header>

    <div class="controls">
      <input id="searchBox" type="text" placeholder="Search products..." />
      <select id="categoryFilter">
        <option value="">All Categories</option>
        <option value="Men">Men</option>
        <option value="Women">Women</option>
        <option value="Kids">Kids</option>
      </select>
    </div>

    <div id="productGrid" class="grid"></div>

    <!-- React root -->
    <div id="root"></div>

    <!-- Hidden snapshot container (will be generated when needed) -->
    <div id="cartSnapshotHolder" style="position:fixed;left:-9999px;top:-9999px;visibility:hidden;"></div>

    <!-- Checkout modal placeholder -->
    <div id="checkoutModalContainer"></div>

    <!-- Loading overlay placeholder -->
    <div id="globalLoadingPlaceholder"></div>

    <!-- React, jsPDF (kept) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <script>
    (function(){
      const { useState, useEffect } = React;

      // CONFIG - update these if different
      const SHEET_URL = 'https://script.google.com/macros/s/AKfycbxENH68uAePu7ORZJawjjXVqvTJfXB8gpBVNfizrdOmyURo8vu4edhr7h9BDc1SdSxlEg/exec';
      const DRIVE_UPLOAD_URL = 'https://script.google.com/macros/s/AKfycbzQFujhLNbFusQfPxsHgQfoXAwcQz-caWSs0JAZDR9VdqEWY_PdKNIDi6ELvFQK03LG/exec';
      const WHATSAPP_NUMBER_WITHOUT_PLUS = '919978653852';

  function App(){
    const [products, setProducts] = useState([]);
    const [filtered, setFiltered] = useState([]);
    const [cart, setCart] = useState(() => JSON.parse(localStorage.getItem('yf_cart') || '[]'));
    const [cartOpen, setCartOpen] = useState(false);
    const [userName, setUserName] = useState('');
    const [userCity, setUserCity] = useState('');
    const [showPopup, setShowPopup] = useState(false);
    const [loading, setLoading] = useState(false);

    useEffect(() => {
      localStorage.setItem('yf_cart', JSON.stringify(cart));
    }, [cart]);

    // --- Add to cart function
    function addToCart(item){
      const idx = cart.findIndex(c => c.pname === item.pname);
      if (idx > -1) {
        const copy = [...cart];
        copy[idx].qty += 1;
        setCart(copy);
      } else {
        setCart([...cart, { ...item, qty: 1 }]);
      }
      alert('✅ Product added to cart!');
    }

    // --- Generate Cart Screenshot
    async function generateCartImage(){
      const target = document.querySelector('.modal-content') || document.body;
      await new Promise(r => setTimeout(r, 800)); // wait for UI render

      const canvas = await html2canvas(target, {
        useCORS: true,
        allowTaint: true,
        backgroundColor: '#ffffff',
        scale: 2
      });

      const dataUrl = canvas.toDataURL('image/jpeg', 0.95);
      return dataUrl.split(',')[1];
    }

    // --- Upload to Drive
    async function uploadToDrive(base64, filename){
      const res = await fetch(DRIVE_UPLOAD_URL, {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: new URLSearchParams({ file: base64, filename })
      });
      const json = await res.json();
      return json.link;
    }

    // --- Confirm Checkout Flow
    async function handleCheckoutConfirm(){
      if (!userName || !userCity) {
        alert('Please enter your Name and City');
        return;
      }
      setShowPopup(false);
      setLoading(true);

      try {
        const base64 = await generateCartImage();
        const link = await uploadToDrive(base64, `Order_${Date.now()}.jpg`);
        
        const total = cart.reduce((s, i) => s + (Number(i.prate) * i.qty), 0);
        let msg = `🛍️ YES FASHION HUB - NEW ORDER\n\nCustomer: ${userName}\nCity: ${userCity}\n\nItems:\n`;
        cart.forEach((c, i) => {
          msg += `${i+1}. ${c.pname} | ₹${c.prate} x ${c.qty}\n`;
        });
        msg += `\nTotal: ₹${total}\n\n🖼️ Cart Image: ${link}`;

        const waUrl = `https://wa.me/${WHATSAPP_NUMBER_WITHOUT_PLUS}?text=${encodeURIComponent(msg)}`;
        window.open(waUrl, '_blank');

        // clear cart
        setCart([]);
        localStorage.removeItem('yf_cart');
      } catch (e) {
        alert('Error creating image or uploading. Check console.');
        console.error(e);
      } finally {
        setLoading(false);
      }
    }

    // --- Main Render
    return React.createElement('div', null,
      React.createElement('div', {className:'grid'},
        filtered.map((p, i) =>
          React.createElement('div', {className:'card', key:i},
            React.createElement('img',{src:p.pimage,alt:p.pname}),
            React.createElement('h3', null, p.pname),
            React.createElement('p', null, p.pdesc),
            React.createElement('button',{className:'btn',onClick:()=>addToCart(p)},'Add to cart')
          )
        )
      ),

      cartOpen && React.createElement('div',{className:'modal'},
        React.createElement('div',{className:'modal-content'},
          React.createElement('h3',null,'Your Cart'),
          cart.map((c,i)=>
            React.createElement('div',{key:i},`${c.pname} (x${c.qty}) - ₹${c.prate}`)
          ),
          React.createElement('div',null,`Total: ₹${cart.reduce((s,i)=>s+Number(i.prate)*i.qty,0)}`),
          React.createElement('button',{className:'btn',onClick:()=>setShowPopup(true)},'Checkout')
        )
      ),

      showPopup && React.createElement('div',{className:'popup'},
        React.createElement('div',{className:'popup-content'},
          React.createElement('h4',null,'Enter Details'),
          React.createElement('input',{placeholder:'Your Name',value:userName,onChange:e=>setUserName(e.target.value)}),
          React.createElement('input',{placeholder:'City',value:userCity,onChange:e=>setUserCity(e.target.value)}),
          React.createElement('button',{className:'btn',onClick:handleCheckoutConfirm},'Confirm')
        )
      ),

      loading && React.createElement('div',{className:'loading'},'🕐 Generating order image...')
    );
  }

  ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
})();
</script>

      





  </body>
</html>
