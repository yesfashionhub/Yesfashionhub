<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>YesFashionHub - Cart & Order</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      body{font-family:Inter,system-ui,Arial;margin:0;background:#f5f5f7}
      .container{max-width:900px;margin:20px auto;padding:16px;background:#fff;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.06)}
      h2{margin-top:0}
      .item{display:flex;gap:12px;padding:10px 0;border-bottom:1px solid #eee;align-items:center}
      .item img{width:80px;height:80px;object-fit:cover;border-radius:6px}
      .right{margin-left:auto;text-align:right}
      .btn{padding:8px 12px;border-radius:6px;border:none;background:#0b74ff;color:#fff;cursor:pointer}
      .loader{display:none;position:fixed;inset:0;background:rgba(255,255,255,0.8);align-items:center;justify-content:center;z-index:999}
      .spinner{border:5px solid #eee;border-top:5px solid #0b74ff;border-radius:50%;width:44px;height:44px;animation:spin 1s linear infinite;margin-right:12px}
      @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
      .controls{display:flex;gap:8px;flex-wrap:wrap}
      input, textarea{width:100%;padding:8px;border:1px solid #ddd;border-radius:6px}
    </style>
  </head>
  <body>
    <div class="container">
      <h2>Yes Fashion Hub — Your Cart</h2>
      <div id="items"></div>
      <div style="text-align:right;font-weight:700;margin-top:12px" id="total"></div>

      <h3 style="margin-top:18px">Customer details</h3>
      <div style="margin-bottom:8px"><input id="custName" placeholder="Your name" /></div>
      <div style="margin-bottom:12px"><textarea id="custAddress" rows="3" placeholder="Delivery address"></textarea></div>

      <div class="controls">
        <button id="confirmBtn" class="btn">Confirm Order — Generate PDF & Upload</button>
        <button id="clearBtn" class="btn" style="background:#888">Clear Cart</button>
      </div>
    </div>

    <div id="loader" class="loader" style="display:none;align-items:center;justify-content:center">
      <div class="spinner"></div>
      <div style="font-weight:700;color:#0b74ff">Processing order — please wait...</div>
    </div>

    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- Include jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
(async function () {
  // CONFIG - change APPS_SCRIPT_WEBAPP_URL to your deployed Apps Script web app URL
  const APPS_SCRIPT_WEBAPP_URL = 'PASTE_YOUR_APPS_SCRIPT_WEBAPP_URL_HERE'; // e.g. https://script.google.com/macros/s/XXXX/exec
  const WHATSAPP_NUMBER = '919978653852'; // your number with country code

  // Replace this with your actual cart data source (your site already has cart)
  // Example format used: [{pname, pdesc, psize, prate, pimage, qty}, ...]
  function getCart() {
    try { return JSON.parse(localStorage.getItem('yf_cart') || '[]'); }
    catch(e) { return []; }
  }

  // Convert an image URL to dataURL (base64)
  async function imageUrlToDataUrl(url) {
    if (!url) return null;
    try {
      const res = await fetch(url);
      if (!res.ok) return null;
      const blob = await res.blob();
      return await new Promise((res2, rej) => {
        const fr = new FileReader();
        fr.onload = () => res2(fr.result);
        fr.onerror = rej;
        fr.readAsDataURL(blob);
      });
    } catch (err) {
      console.warn('image fetch error', url, err);
      return null;
    }
  }

  // Build PDF (returns blob)
  async function buildPdfBlob(customerName, customerAddress) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: 'pt', format: 'a4' });
    const startX = 40;
    let y = 40;
    const cart = getCart();
    doc.setFontSize(18);
    doc.text('Yes Fashion Hub - Order', startX, y);
    y += 24;
    doc.setFontSize(12);
    doc.text(`Customer: ${customerName}`, startX, y); y += 16;
    doc.text(`Address: ${customerAddress}`, startX, y); y += 20;

    let total = 0;
    for (const it of cart) {
      const price = Number(it.prate || it.price || 0);
      const qty = Number(it.qty || 1);
      total += price * qty;

      // try to fetch image and add as thumbnail
      const imgUrl = it.pimage || it.image || it.Pimage || '';
      let dataUrl = null;
      if (imgUrl) dataUrl = await imageUrlToDataUrl(imgUrl);

      if (dataUrl) {
        try { doc.addImage(dataUrl, 'JPEG', startX, y, 60, 60); } catch(e){ console.warn('pdf addImage fail', e); }
      }
      const leftTextX = startX + 70;
      doc.setFontSize(12);
      doc.text(String(it.pname || it.name || ''), leftTextX, y + 16);
      if (it.pdesc) doc.setFontSize(10), doc.text(String(it.pdesc || ''), leftTextX, y + 34);
      doc.setFontSize(10);
      doc.text(`Size: ${it.psize || it.size || '-'} | ₹${price} x ${qty}`, leftTextX, y + 52);
      y += 80;
      if (y > 720) { doc.addPage(); y = 40; }
    }

    doc.setFontSize(13);
    doc.text(`Total: ₹${Number(total).toFixed(2)}`, startX, y + 10);

    // return blob
    return doc.output('blob');
  }

  // Convert blob -> base64 string
  function blobToBase64(blob) {
    return new Promise((res, rej) => {
      const reader = new FileReader();
      reader.onload = () => {
        const dataUrl = reader.result; // data:application/pdf;base64,AAA...
        res(dataUrl.split(',')[1]); // return only base64 part
      };
      reader.onerror = rej;
      reader.readAsDataURL(blob);
    });
  }

  // Upload to Apps Script
  async function uploadPdf(filename, base64Content) {
    const payload = { filename: filename, contentBase64: base64Content };
    const resp = await fetch(APPS_SCRIPT_WEBAPP_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    return resp.json();
  }

  // UI: Hook to a confirm button on your page
  // Example: <button id="confirmOrderBtn">Confirm Order</button>
  const btn = document.getElementById('confirmOrderBtn');
  if (!btn) {
    console.warn('No #confirmOrderBtn found — create button with id confirmOrderBtn to enable order flow.');
    return;
  }

  btn.addEventListener('click', async function () {
    try {
      const cname = prompt('Enter your name:');
      const caddr = prompt('Enter your address:');
      if (!cname || !caddr) { alert('Name & address required'); return; }

      btn.disabled = true;
      btn.innerText = 'Processing...';

      const now = new Date();
      const datePart = now.toISOString().slice(0,10);
      const safeName = cname.replace(/\s+/g,'_').replace(/[^a-zA-Z0-9_\-]/g,'');
      const filename = `${safeName}_${datePart}.pdf`;

      const pdfBlob = await buildPdfBlob(cname, caddr);
      const base64 = await blobToBase64(pdfBlob);

      const result = await uploadPdf(filename, base64);
      btn.disabled = false;
      btn.innerText = 'Confirm Order';

      if (result && result.success && result.url) {
        const pdfLink = result.url;
        const message = `My Name is ${cname}%0AAddress: ${caddr}%0A%0APlease find my Order PDF and confirm my order soon as possible.%0A${pdfLink}`;
        const waUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(message)}`;
        window.open(waUrl, '_blank');
        alert('Order uploaded & WhatsApp opened. PDF link: ' + pdfLink);
      } else {
        console.error('Upload failed', result);
        alert('Upload failed: ' + (result && result.error ? result.error : 'unknown'));
      }
    } catch (err) {
      console.error(err);
      alert('Error creating or uploading PDF. Check console.');
      btn.disabled = false;
      btn.innerText = 'Confirm Order';
    }
  });

})(); // end IIFE
</script>

 </body>
</html>
