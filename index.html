<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>YesFashionHub - WhatsApp Store</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      /* Basic styling - tweak as you like */
      body{font-family:Inter,system-ui,Arial;margin:0;background:#f5f5f7}
      .container{max-width:1200px;margin:0 auto;padding:16px}
      header{display:flex;align-items:center;justify-content:space-between;padding:12px 0}
      .logo{display:flex;align-items:center;gap:8px}
      .logo img{height:48px;border-radius:8px}
      .search-bar{display:flex;gap:8px;margin:12px 0}
      .search-bar input, .search-bar select{padding:8px;border-radius:6px;border:1px solid #ddd}
      .slider{height:180px;background:#ddd;border-radius:8px;margin:12px 0;display:flex;align-items:center;justify-content:center}
      .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
      .card{background:#fff;border-radius:8px;padding:10px;box-shadow:0 1px 4px rgba(0,0,0,0.06)}
      .card img{width:100%;height:160px;object-fit:cover;border-radius:6px}
      .btn{padding:8px 10px;border-radius:6px;border:none;background:#0b74ff;color:#fff;cursor:pointer}
      .cart-btn{position:relative}
      .cart-count{position:absolute;top:-6px;right:-6px;background:#ff3b30;color:#fff;padding:4px 6px;border-radius:50%;font-size:12px}
      .modal{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center}
      .modal-content{background:#fff;padding:16px;border-radius:8px;max-width:800px;width:100%;max-height:90vh;overflow:auto}
      .cart-row{display:flex;gap:12px;align-items:center;padding:8px 0;border-bottom:1px solid #eee}
      .cart-row img{width:80px;height:80px;object-fit:cover;border-radius:6px}
      .divider{height:1px;background:#eee;margin:8px 0}
    </style>
  </head>
  <body>
    <div id="root"></div>

    <!-- React & ReactDOM via CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
    (function(){
      const { useState, useEffect } = React;
      const SPREADSHEET_ID = '1YYgPtaOMGX4C9WP9W-z_BYrkgbd8268RkGoyWD6AyX8'; // update if different
      const SHEET_NAME = 'yesfashionhub';

      function fetchSheet() {
        const url = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}`;
        return fetch(url).then(r => r.text()).then(txt => {
          // gviz returns "/*O_o*/\ngoogle.visualization.Query.setResponse({...})"
          const json = JSON.parse(txt.replace(/^[^{]*{/,'{').replace(/}\);?$/,'}'));
          const cols = json.table.cols.map(c=>c.label || c.id || '');
          const rows = json.table.rows.map(r => {
            const obj = {};
            r.c.forEach((cell,i) => {
              obj[cols[i]] = cell ? cell.v : '';
            });
            return obj;
          });
          return rows;
        });
      }

      function App(){
        const [data, setData] = useState([]);
        const [filtered, setFiltered] = useState([]);
        const [categories, setCategories] = useState([]);
        const [q, setQ] = useState('');
        const [cat, setCat] = useState('All');
        const [cartOpen, setCartOpen] = useState(false);
        const [cart, setCart] = useState(()=> {
          try { return JSON.parse(localStorage.getItem('yf_cart')||'[]') } catch(e){ return [] }
        });

        useEffect(()=> {
          fetchSheet().then(rows => {
            // Normalize field names (lowercase keys)
            const normalized = rows.map(r => {
              return {
                category: r['Category'] || r['categories'] || r['CATEGORY'] || r['category'] || '',
                pname: r['Pname'] || r['pname'] || r['Product name'] || r['PName'] || '',
                pdesc: r['Pdesc'] || r['pdesc'] || r['Pdesc '] || r['Pdesc'] || '',
                psize: r['Psize'] || r['psize'] || r['size'] || '',
                prate: r['Prate'] || r['prate'] || r['Price'] || r['prate '] || '',
                pimage: r['Pimage'] || r['pimage'] || r['Pimage '] || r['pimage url'] || ''
              };
            });
            setData(normalized);
            setFiltered(normalized);
            const cats = Array.from(new Set(normalized.map(x => x.category || 'Uncategorized')));
            setCategories(['All',...cats]);
          }).catch(err => {
            console.error('Error fetching sheet', err);
            alert('Error fetching product sheet. Make sure you published the sheet to web and sheet name matches.');
          });
        },[]);

        useEffect(()=> {
          localStorage.setItem('yf_cart', JSON.stringify(cart));
        },[cart]);

        useEffect(()=> {
          let out = data.filter(d => {
            const matchesQ = !q || (d.pname && d.pname.toLowerCase().includes(q.toLowerCase())) || (d.pdesc && d.pdesc.toLowerCase().includes(q.toLowerCase()));
            const matchesCat = (cat === 'All') || (!cat && true) || (d.category === cat);
            return matchesQ && matchesCat;
          });
          setFiltered(out);
        },[data,q,cat]);

        function addToCart(item){
          const exist = cart.find(c => c.pname === item.pname && c.pimage === item.pimage);
          if (exist) {
            setCart(cart.map(c => c === exist ? {...c, qty: c.qty + 1} : c));
          } else {
            setCart([...cart, {...item, qty:1}]);
          }
        }
        function removeFromCart(item){
          setCart(cart.filter(c => c !== item));
        }
        function changeQty(item, delta){
          setCart(cart.map(c => c === item ? {...c, qty: Math.max(1, c.qty + delta)} : c));
        }

        async function generatePDFAndDownload() {
          if (cart.length === 0) { alert('Cart empty'); return; }
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF({unit:'px', format:'a4'});
          const startY = 40;
          doc.setFontSize(16);
          doc.text('Yes Fashion Hub - Order', 40, 30);
          let y = startY;
          for (const item of cart) {
            // try add image (if cross-origin blocked, skip)
            if (item.pimage) {
              try {
                const resp = await fetch(item.pimage);
                const blob = await resp.blob();
                const reader = new FileReader();
                const dataUrl = await new Promise((res, rej) => {
                  reader.onload = () => res(reader.result);
                  reader.onerror = rej;
                  reader.readAsDataURL(blob);
                });
                doc.addImage(dataUrl, 'JPEG', 40, y, 80, 80);
              } catch(e){
                console.warn('Could not fetch image for PDF (CORS?)', e);
              }
            }
            doc.setFontSize(12);
            doc.text(`${item.pname || ''} - ${item.pdesc || ''}`, 140, y + 20);
            doc.text(`Size: ${item.psize || '-'} | Rate: ${item.prate || '-'} | Qty: ${item.qty}`, 140, y + 40);
            y += 100;
            if (y > 750) { doc.addPage(); y = 40; }
          }
          // Add total
          const total = cart.reduce((s,i)=> s + (Number(i.prate || 0) * Number(i.qty || 1)), 0);
          doc.setFontSize(14);
          doc.text(`Total: ₹${total}`, 40, y + 20);
          const filename = `order_${Date.now()}.pdf`;
          doc.save(filename);
          alert('PDF generated. Downloaded file: ' + filename + '. Now you can forward it on WhatsApp.');
        }

        function shareViaWhatsApp() {
          if (cart.length === 0) { alert('Cart empty'); return; }
          // Build a message with order summary and product image links
          let msg = `Hello Yes Fashion Hub,%0AI would like to place this order:%0A%0A`;
          cart.forEach((c, idx) => {
            msg += `${idx+1}. ${c.pname} | ${c.pdesc || ''} | Qty:${c.qty} | Rate:${c.prate || '-'}%0A`;
            if (c.pimage) msg += `Image: ${encodeURIComponent(c.pimage)}%0A`;
            msg += `%0A`;
          });
          const total = cart.reduce((s,i)=> s + (Number(i.prate || 0) * Number(i.qty || 1)), 0);
          msg += `Total: ₹${total}%0A%0A`;
          msg += `Please confirm order and provide payment details.%0A`;
          const waUrl = `https://wa.me/?text=${msg}`; // opens WhatsApp web/mobile with prefilled message
          window.open(waUrl, '_blank');
        }

        return (
          React.createElement('div',{className:'container'},
            React.createElement('header',null,
              React.createElement('div',{className:'logo'},
                React.createElement('img',{src:'https://via.placeholder.com/80x80.png?text=Logo', alt:'logo'}),
                React.createElement('div',null,
                  React.createElement('div',{style:{fontWeight:700,fontSize:18}},'Yes Fashion Hub'),
                  React.createElement('div',{style:{fontSize:12,color:'#666'}},'Custom Prints & Designs')
                )
              ),
              React.createElement('div',null,
                React.createElement('button',{className:'btn cart-btn', onClick:()=>setCartOpen(true)},'Cart'),
                cart.length>0 && React.createElement('span',{className:'cart-count'},cart.reduce((s,i)=>s+i.qty,0))
              )
            ),
            React.createElement('div',{className:'slider'},' Slider area (add images / promos later)'),
            React.createElement('div',{className:'search-bar'},
              React.createElement('input',{placeholder:'Search products...', value:q, onChange:e=>setQ(e.target.value)}),
              React.createElement('select',{value:cat,onChange:e=>setCat(e.target.value)},
                categories.map(c=>React.createElement('option',{key:c,value:c},c))
              )
            ),
            React.createElement('div',{className:'grid'},
              filtered.map((p,idx)=>
                React.createElement('div',{className:'card',key:idx},
                  React.createElement('img',{src:p.pimage || 'https://via.placeholder.com/400x300?text=No+Image', alt:p.pname}),
                  React.createElement('h3',null,p.pname || 'Unnamed'),
                  React.createElement('p',null,p.pdesc || ''),
                  React.createElement('p',null,'Size: ' + (p.psize || '-')),
                  React.createElement('p',null,'₹' + (p.prate || '-')),
                  React.createElement('div',null,
                    React.createElement('button',{className:'btn', onClick:()=>addToCart(p)},'Add to cart')
                  )
                )
              )
            ),
            cartOpen && React.createElement('div',{className:'modal'},
              React.createElement('div',{className:'modal-content'},
                React.createElement('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center'}},
                  React.createElement('h3',null,'Your Cart'),
                  React.createElement('div',null,
                    React.createElement('button',{className:'btn', onClick:()=>{generatePDFAndDownload()}},'Download PDF'),
                    ' ',
                    React.createElement('button',{className:'btn', onClick:()=>shareViaWhatsApp()},'Share on WhatsApp'),
                    ' ',
                    React.createElement('button',{className:'btn', onClick:()=>setCartOpen(false)},'Close')
                  )
                ),
                React.createElement('div',{className:'divider'}),
                cart.length===0 ? React.createElement('div',null,'Cart is empty') :
                cart.map((c, i) =>
                  React.createElement('div',{className:'cart-row',key:i},
                    React.createElement('img',{src:c.pimage || 'https://via.placeholder.com/80', alt:c.pname}),
                    React.createElement('div',{style:{flex:1}},
                      React.createElement('div',{style:{fontWeight:600}},c.pname),
                      React.createElement('div',null,c.pdesc),
                      React.createElement('div',null,'Size: ' + (c.psize || '-')),
                      React.createElement('div',null,'₹' + (c.prate || '-') + ' x ' + c.qty)
                    ),
                    React.createElement('div',null,
                      React.createElement('button',{onClick:()=>changeQty(c,1)},'+'),
                      React.createElement('button',{onClick:()=>changeQty(c,-1)},'-'),
                      React.createElement('button',{onClick:()=>removeFromCart(c)},'Remove')
                    )
                  )
                )
              )
            )
          )
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
    })();
    </script>
  </body>
</html>
