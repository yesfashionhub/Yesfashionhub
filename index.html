<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>YES FASHION HUB - Store</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<style>
body{margin:0;font-family:'Inter',Arial,sans-serif;background:#f2f5f3;color:#222}
header{background:#25D366;color:#fff;padding:12px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 3px 8px rgba(0,0,0,0.15)}
header img{height:60px;border-radius:8px;background:#fff;padding:4px}
.cart-btn{background:#128C7E;color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
.cart-count{background:#ff3b30;color:#fff;border-radius:50%;padding:4px 7px;font-size:12px;position:relative;top:-10px;right:10px}
.controls{display:flex;gap:8px;padding:10px;background:#fff;margin:10px}
.controls input,.controls select{padding:10px;border:1px solid #ccc;border-radius:8px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;padding:10px}
.card{background:#fff;border-radius:8px;padding:8px;box-shadow:0 2px 6px rgba(0,0,0,0.08)}
.card img{width:100%;height:160px;object-fit:cover;border-radius:8px}
.btn{background:#25D366;color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer}
.modal{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:9999}
.modal-box{background:#fff;border-radius:10px;max-width:420px;width:95%;padding:16px}
.loader{width:50px;height:50px;border:6px solid #ccc;border-top:6px solid #25D366;border-radius:50%;animation:spin 1s linear infinite;margin:auto}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>

<body>
<header>
  <div style="display:flex;align-items:center;gap:10px">
    <img src="https://raw.githubusercontent.com/yesfashionhub/yesfashionhub.github.io/main/cropped-yes-lOGO.webp">
    <h2>YES FASHION HUB</h2>
  </div>
  <div>
    <button class="cart-btn" onclick="openCart()">üõçÔ∏è Cart</button>
    <span id="cartCount" class="cart-count">0</span>
  </div>
</header>

<div class="controls">
  <input id="searchBox" placeholder="Search products...">
  <select id="categoryFilter"><option value="All">All</option></select>
</div>

<div id="productGrid" class="grid"></div>

<!-- Modal root -->
<div id="modalRoot"></div>

<script type="module">
/******** CONFIG *********/
const SHEET_URL = "https://script.google.com/macros/s/AKfycbzvaEHLr2h7504eFEuOKiZWJU-iLfzNMXQdUjoET1SuNRbgIi58lOM9uv8if3k1tarN/exec";
  
const DRIVE_UPLOAD_URL = https://script.google.com/macros/s/AKfycbzvaEHLr2h7504eFEuOKiZWJU-iLfzNMXQdUjoET1SuNRbgIi58lOM9uv8if3k1tarN/exec";
const WHATSAPP_NUMBER_WITHOUT_PLUS = "919978653852";

/*************************/
let products=[],cart=[];
function $(id){return document.getElementById(id)}
function renderProducts(){
  const q=$('searchBox').value.toLowerCase();
  const cat=$('categoryFilter').value;
  const grid=$('productGrid'); grid.innerHTML='';
  const f=products.filter(p=>(cat==='All'||p.Categories===cat)&&(!q||p.Pname.toLowerCase().includes(q)||p.Pdesc.toLowerCase().includes(q)));
  f.forEach(p=>{
    const img=(p.Pimage||'').split(/[,]+/)[0];
    const card=document.createElement('div');
    card.className='card';
    card.innerHTML=`
      <img src="${img}" alt="">
      <h3>${p.Pname}</h3>
      <p>${p.Pdesc||''}</p>
      <p><b>‚Çπ${p.Prate}</b> (${p.Pgst})</p>
      <button class="btn" onclick='addToCart(${JSON.stringify(p)})'>Add to Cart</button>`;
    grid.appendChild(card);
  });
}

async function fetchSheet() {
  try {
    const res = await fetch(SHEET_URL);
    const j = await res.json();

    if (!j || !j.data) {
      console.error("No data found in Google Sheet response");
      return;
    }

    products = j.data;

    // ‚úÖ Extract unique categories, ignore blanks
    const cats = [...new Set(products.map(p => (p.Categories || '').trim()))].filter(Boolean);

    // ‚úÖ Add category filter dropdown
    document.getElementById('categoryFilter').innerHTML =
      '<option value="All">All</option>' +
      cats.map(c => `<option>${c}</option>`).join('');

    // ‚úÖ Render products
    renderProducts();

  } catch (err) {
    console.error("Error fetching sheet data:", err);
    alert("‚ö†Ô∏è Failed to load products. Please check your internet or Sheet URL.");
  }
}

  
function addToCart(p){
  const e=cart.find(x=>x.Pname===p.Pname);
  if(e)e.qty++; else{p.qty=1;cart.push(p);}
  $('cartCount').innerText=cart.reduce((a,b)=>a+b.qty,0);
  alert("‚úÖ Added to cart");
}
function openCart(){
  if(!cart.length){alert('Cart empty');return;}
  const div=document.createElement('div');div.className='modal';
  let html=`<div class='modal-box'><h3>Your Cart</h3>`;
  cart.forEach((c,i)=>{
    const img=(c.Pimage||'').split(/[,]+/)[0];
    html+=`<div style='display:flex;gap:10px;margin-bottom:6px;'>
      <img src='${img}' style='width:60px;height:60px;object-fit:cover;border-radius:6px'>
      <div style='flex:1'><b>${c.Pname}</b><br>Qty: ${c.qty} x ‚Çπ${c.Prate}</div>
    </div>`;
  });
  html+=`<hr><button class='btn' onclick='checkout()'>Checkout</button>
         <button class='btn' style='background:#ccc;color:#000' onclick='closeModal()'>Close</button></div>`;
  div.innerHTML=html; $('modalRoot').appendChild(div);
}
function closeModal(){$('modalRoot').innerHTML='';}

/******** CHECKOUT ********/
async function checkout(){
  closeModal();
  const formDiv=document.createElement('div');
  formDiv.className='modal';
  formDiv.innerHTML=`<div class='modal-box'>
    <h3>Customer Details</h3>
    <input id='uname' placeholder='Full Name' style='width:100%;padding:8px;margin:6px 0'>
    <input id='uaddr' placeholder='Address' style='width:100%;padding:8px;margin:6px 0'>
    <input id='ucity' placeholder='City' style='width:100%;padding:8px;margin:6px 0'>
    <input id='umob' placeholder='Mobile' style='width:100%;padding:8px;margin:6px 0'>
    <button class='btn' onclick='generatePDF()'>Confirm Order</button>
  </div>`;
  $('modalRoot').appendChild(formDiv);
}


  async function generatePDF() { 
  const name = $('uname').value,
        addr = $('uaddr').value,
        city = $('ucity').value,
        mob  = $('umob').value;

  if (!name || !city || !mob) return alert('Please fill all fields!');

  $('modalRoot').innerHTML = `
    <div class='modal'>
      <div class='modal-box'>
        <div class='loader'></div>
        <p>Processing your order...</p>
      </div>
    </div>`;

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: 'pt', format: 'a4' });

  doc.setFontSize(18);
  doc.text("YES FASHION HUB", 220, 40);
  doc.setFontSize(12);
  doc.text(`Name: ${name}`, 40, 70);
  doc.text(`Address: ${addr}`, 40, 85);
  doc.text(`City: ${city}`, 40, 100);
  doc.text(`Mobile: ${mob}`, 40, 115);
  doc.line(40, 125, 550, 125);

  let y = 145;
  let total = 0;
  doc.setFontSize(13);

  for (const [i, c] of cart.entries()) {
    const imgUrl = (c.Pimage || '').split(/[,]+/)[0];
    const lineTotal = (+c.Prate) * c.qty;
    total += lineTotal;

    doc.text(`${i + 1}. ${c.Pname}`, 40, y);
    doc.text(`Qty: ${c.qty}`, 400, y);
    doc.text(`‚Çπ${c.Prate}`, 460, y);
    doc.text(`= ‚Çπ${lineTotal}`, 520, y);
    y += 18;

    // ‚úÖ Add image with proper await
    if (imgUrl) {
      try {
        const imgEl = document.createElement('img');
        imgEl.src = imgUrl;
        await new Promise(res => imgEl.onload = res);
        doc.addImage(imgEl, 'JPEG', 60, y, 80, 80);
        y += 90;
      } catch (e) {
        console.warn("Image load failed:", e);
      }
    }
  }

  // Finish total
  doc.text(`Total: ‚Çπ${total}`, 460, y + 30);

  const pdfBlob = doc.output('blob');
  // TODO: upload pdfBlob to Drive here
}

fetchSheet();
</script>
</body>
</html>
